# HTU_Student WiFi 校园网自动认证脚本

这是一个用于在 OpenWrt 路由器上自动连接并认证 HTU_Student WiFi 网络的脚本。脚本会模拟浏览器行为，自动完成 Portal 认证流程。

## 工作原理

脚本的工作流程如下：

1. **获取设备信息**
   - 自动从 WiFi 接口获取 IP 地址（过滤 LAN IP）
   - 自动获取 MAC 地址
   - 自动获取主机名

2. **检查网络状态**
   - 尝试访问外部网站检测网络连接
   - 尝试访问会被重定向到 Portal 的 URL（generate_204）

3. **Portal 检测**
   - 如果被重定向到 Portal，说明需要认证
   - 从 Portal URL 自动提取参数（IP、AC名称、VLAN等）

4. **执行认证**
   - 构建 `quickauth.do` 认证 URL
   - 模拟浏览器发送 GET 请求
   - 包含所有必要的请求头和 Cookie

5. **记录日志**
   - 记录认证状态和服务器响应
   - 自动解析响应中的状态码和消息

## 功能特性

- ✅ **自动获取设备信息**：自动检测 WiFi 接口的 IP 地址、MAC 地址和主机名
- ✅ **智能网络检测**：自动检测 Portal 重定向，判断是否需要认证
- ✅ **浏览器行为模拟**：完全模拟浏览器认证流程，使用 `quickauth.do` 接口
- ✅ **参数自动解析**：从 Portal URL 自动提取认证所需参数（AC名称、VLAN、IP等）
- ✅ **日志记录**：记录每次认证的状态和响应
- ✅ **错误处理**：详细的错误信息提示和日志记录
- ✅ **自动重试**：定时运行可保持在线状态

## 前置要求

- OpenWrt 系统
- 已连接到 HTU_Student WiFi 网络
- curl 工具（通常 OpenWrt 已包含）
- awk、sed、grep 等基本工具（BusyBox 已包含）

## 配置步骤

### 1. 上传脚本到 OpenWrt

将 `loader.sh` 上传到你的 OpenWrt 设备，建议放在 `/root/` 或 `/etc/` 目录下。

### 2. 修改配置参数

编辑 `loader.sh` 文件，修改以下**必须配置**的参数：

#### 2.1 用户认证信息（必须修改）

```bash
# 学号（请修改为你的学号）
userid=250408****

# 密码（请修改为你的密码）
password="Myhtu****"

#### 2.2 WiFi 接口名称（可能需要修改）

```bash
# WiFi接口名称
wanInterface="phy0-sta0"
```


## 使用方法

### 首次使用

1. **赋予执行权限**：
   ```bash
   chmod +x loader.sh
   ```

2. **确保 WiFi 已连接**：
   ```bash
   # 检查 WiFi 连接状态
   iwconfig phy0-sta0
   
   # 检查是否获取到 IP
   ip addr show phy0-sta0
   ```

3. **手动运行测试**：
   ```bash
   ./loader.sh
   ```

4. **查看日志**：
   ```bash
   cat captive.log
   ```

### 定时自动运行（推荐）

为了保持网络连接，建议设置定时任务自动运行脚本。

#### 使用 crontab（推荐）

```bash
# 编辑 crontab
crontab -e

# 添加以下任务（根据你的脚本路径修改）
# 每 5 分钟检查一次认证状态
*/5 * * * * /root/loader.sh >> /tmp/auth.log 2>&1

# 开机后立即认证
@reboot sleep 30 && /root/loader.sh >> /tmp/auth.log 2>&1
```


## 日志说明

脚本会生成 `captive.log` 日志文件，记录每次运行的结果。

日志格式：
```
--------------------------------
操作时间: 2025年11月03日 01:37:42
网络状态: 认证成功 / 网络正常 / 认证失败等
响应详情: 服务器返回的详细响应
```

## 常见问题

### 1. 无法获取 IP 地址

**症状**：日志显示 "IP地址为空" 或获取到 `192.168.x.x` 这样的 LAN IP

**解决方法**：
- 检查 WiFi 是否已连接到 HTU_Student
- 确认 WiFi 接口名称是否正确
- 等待 DHCP 分配 IP（通常需要几秒到几十秒）
- 手动查看接口状态：`ip addr show phy0-sta0`

### 2. 认证响应 code="0"

**症状**：收到响应但 `code: "0"`，所有字段为 null

**可能原因**：
- 参数不完整或不正确
- Portal 服务器需要先访问 Portal 页面建立会话
- IP 地址不正确（使用了 LAN IP 而非校园网 IP）

**解决方法**：
- 确保脚本能正确获取校园网分配的 IP（10.104.x.x）
- 检查脚本输出的参数是否正确
- 查看完整日志了解详细信息

### 3. 无法连接到 Portal 服务器

**症状**：`Failed to connect to 10.101.2.194 port 6060`

**可能原因**：
- WiFi 未连接到 HTU_Student
- 网络未获取到 DHCP IP
- 防火墙规则阻止了连接

**解决方法**：
- 确认 WiFi 已连接：`iwconfig phy0-sta0`
- 检查 IP 地址：`ip addr show phy0-sta0`
- 手动测试连接：`curl -v http://10.101.2.194:6060/portal.do`

### 4. 认证失败但响应为空

**症状**：HTTP 状态码正常但响应体为空

**可能原因**：
- 服务器返回了压缩响应但 curl 未正确解压
- 网络不稳定导致响应不完整

**解决方法**：
- 脚本已包含 `--compressed` 选项自动解压
- 检查网络连接稳定性
- 增加超时时间（脚本已设置为 30 秒）

### 5. 用户名或密码错误

**症状**：服务器返回密码错误相关消息

**解决方法**：
- 检查 `userid` 和 `password` 是否正确
- 确认 `operatorSuffix` 是否匹配你的账户类型
- 尝试在浏览器中手动登录验证账户信息


## 重要提示

⚠️ **安全提醒**：
1. 脚本中包含你的密码（明文），请妥善保管脚本文件
2. 建议设置适当的文件权限：`chmod 600 loader.sh`
3. 不要将包含真实密码的脚本上传到公共代码仓库

⚠️ **注意事项**：
1. 首次使用前务必修改学号和密码
2. 确认 WiFi 接口名称是否正确
3. 测试脚本是否能正常工作后再设置定时任务
4. 定期检查日志，确保认证正常


## 技术支持

作者：liq45@live.com

---

**祝你使用愉快！** 🎉
